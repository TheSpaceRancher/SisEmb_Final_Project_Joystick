#include <18F4550.h>

#fuses HSPLL,NOWDT,NOPROTECT,NOLVP,NODEBUG,USBDIV,PLL5,CPUDIV1,VREGEN, XT
#use delay(clock=48000000)

#include <pic18_usb.h>
#include <joy_control.h>
#include <usb.c>

#define JOY_AXIS_X 0
#define JOY_AXIS_Y 1

#define JOY_BUTTON 1


typedef struct buttons_state {
   int8 button_joystick;
   int8 button_RB;
   int8 button_LB;
   int8 button_Y;
   int8 button_B;
   int8 button_A;
   int8 button_X;
   int8 button_Up;
   int8 button_Left;
   int8 button_Right;
   int8 button_Down;
} buttons_state;

buttons_state read_Buttons(){
   buttons_state reading;
   reading.button_joystick = input(PIN_A2)? 2 : 0;
   reading.button_RB = input(PIN_D4);
   reading.button_LB = input(PIN_D5);
   reading.button_Y = input(PIN_D0);
   reading.button_B = input(PIN_D1);
   reading.button_A = input(PIN_D2);
   reading.button_X = input(PIN_D3);
   reading.button_Up = input(PIN_B0);
   reading.button_Left = input(PIN_B1);
   reading.button_Right = input(PIN_B2);
   reading.button_Down = input(PIN_B3);
   return reading;
}


int8 adc_offset(int8 channel){
   int i;
   int32 sum = 0;
   for(i=0;i<8;i++){
      set_adc_channel(channel);
      delay_us(20);
      sum += read_adc();
      delay_ms(5);
   }
   return (int8)(((sum / 8) * 255) / 1023);
}

int8 read_joystick(int8 channel, int8 offset){
   set_adc_channel(channel);
   delay_us(20);
   
   int16 adc = read_adc();
   adc = ((adc*255) / 1023)- offset;
   return (int8)adc;
}

void main()
{
   usb_init_cs();

   int8 data[4];

   int8 moveX = 0;
   int8 moveY = 0;

   int8 offsetX = 128;
   int8 offsetY = 128;

   buttons_state buttons;
   
   setup_adc_ports(All_ANALOG);
   setup_adc(ADC_CLOCK_INTERNAL);

   set_tris_a(0b00000011);

   offsetX = adc_offset(0);
   offsetY = adc_offset(1);

   while(TRUE)
   {
     
      usb_task();

      if(usb_enumerated()){

         buttons = read_Buttons();

         data[0] = buttons.button_joystick;
         data[1] = read_joystick(JOY_AXIS_X, offsetX);
         data[2] = read_joystick(JOY_AXIS_Y, offsetY);
         data[3] = 0;

         usb_put_packet(1, data, 4, USB_DTS_TOGGLE);
      }
   }
}
